package conv2d;

import com.custom_computing_ic.maxdeep.kernel.conv2d.ConvLayerParameters;
import com.custom_computing_ic.maxdeep.kernel.conv2d.lib.Conv2DKernel;
import com.maxeler.maxcompiler.v2.kernelcompiler.Kernel;
import com.maxeler.maxcompiler.v2.kernelcompiler.KernelConfiguration;
import com.maxeler.maxcompiler.v2.kernelcompiler.KernelConfiguration.OptimizationOptions.DSPMulAddChainBehaviour;
import com.maxeler.maxcompiler.v2.kernelcompiler.KernelParameters;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.base.DFEFix.SignMode;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.base.DFEType;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.base.DFEVar;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.composite.DFEVector;

/**
 * Kernel for generating Conv2DKernel different parameters
 * 
 * @author rz3515
 * 
 */
public class Conv2DWrapKernel extends Kernel {

  public static final String        IFMAP_NAME = "ifmap";
  public static final String        COEFF_NAME = "coeff";
  public static final String        OFMAP_NAME = "ofmap";

  private final ConvLayerParameters convParams;

  public Conv2DWrapKernel(KernelParameters params,
      ConvLayerParameters convParams) {
    super(params);
    
    // TODO: remove muladd optimisation for now
    KernelConfiguration config = getKernelConfig();
    config.optimization.setDSPMulAddChainBehavior(DSPMulAddChainBehaviour.IGNORE);

    this.convParams = convParams;

    DFEType scalarT = dfeFix(0, convParams.BW, SignMode.UNSIGNED);

    optimization.pushDSPFactor(1.0);
    Conv2DKernel conv2d = new Conv2DKernel(getKernel(), convParams, scalarT);
    optimization.popDSPFactor();
    
    DFEVector<DFEVar> ifmap = io.input(IFMAP_NAME, conv2d.getIfmapT());
    DFEVector<DFEVar> coeff = io.input(COEFF_NAME, conv2d.getCoeffT());
    
    DFEVector<DFEVar> ifmapCacheVec = conv2d.getIfmapT().newInstance(getKernel());
    DFEVector<DFEVar> coeffCacheVec = conv2d.getCoeffT().newInstance(getKernel());
    
    for (int i = 0; i < conv2d.getIfmapT().getSize(); i ++)
      ifmapCacheVec[i].connect(optimization.pipeline(ifmap[i]));
    for (int i = 0; i < conv2d.getCoeffT().getSize(); i ++)
      coeffCacheVec[i].connect(optimization.pipeline(coeff[i]));
    
    conv2d.setInputs(ifmapCacheVec, coeffCacheVec);
    
    io.output(OFMAP_NAME, conv2d.getOfmapT()) <== conv2d.getOfmap();
  }
}
